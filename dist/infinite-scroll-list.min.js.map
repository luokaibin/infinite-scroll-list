{"version":3,"file":"infinite-scroll-list.min.js","sources":["../src/infinite-scroll-list.ts"],"sourcesContent":["/**\n * 无限滚动加载组件\n * \n * 功能：\n * 1. 支持传入距离底部的距离参数(on-end-reached-threshold)\n * 2. 支持外部传入是否还有下一页(has-next-page)\n * 3. 支持两个slot：loading和no-data\n * 4. 根据是否有下一页显示对应的slot内容\n * 5. 支持在body中使用，也支持在父或祖先元素overflow-y: auto的元素中使用\n * 6. 自适应父元素大小变化\n * 7. 组件只在has-next-page为true时触发end-reached事件\n * 8. 支持向上加载功能，通过has-previous-page控制是否有上一页\n * 9. 支持传入距离顶部的距离参数(on-start-reached-threshold)\n * 10. 组件只在has-previous-page为true时触发start-reached事件\n */\n\n// 定义组件的样式\nconst style = `\n:host {\n  display: block;\n  width: 100%;\n  height: 100%;\n}\n\n.relative {\n  position: relative;\n}\n\n.absolute {\n  position: absolute;\n}\n\n.bottom-0 {\n  bottom: 0px;\n}\n\n.top-0 {\n  top: 0px;\n}\n\n.z-\\\\[-1\\\\] {\n  z-index: -1;\n}\n\n.w-full {\n  width: 100%;\n}\n\n.hidden {\n  display: none;\n}\n\n.contents {\n  display: contents;\n}\n`;\n\n// 定义观察器类型\nenum ObserverType {\n  Top = 'top',\n  Bottom = 'bottom'\n}\n\n// 定义槽类型\nenum SlotType {\n  TopLoading = 'top-loading',\n  Loading = 'loading',\n  NoData = 'no-data'\n}\n\nclass InfiniteScrollList extends HTMLElement {\n  // 私有属性\n  private _observers: Map<ObserverType, IntersectionObserver | null> = new Map();\n  private _resizeObserverRef: ResizeObserver | null = null;\n  private _refElements: Map<ObserverType, HTMLDivElement | null> = new Map();\n  private _thresholds: Map<string, number> = new Map();\n  private _flags: Map<string, boolean> = new Map();\n  private _container: HTMLDivElement | null = null;\n\n  constructor() {\n    super();\n    \n    // 创建 Shadow DOM\n    this.attachShadow({ mode: 'open' });\n    \n    // 初始化Maps\n    this._observers.set(ObserverType.Top, null);\n    this._observers.set(ObserverType.Bottom, null);\n    this._refElements.set(ObserverType.Top, null);\n    this._refElements.set(ObserverType.Bottom, null);\n    \n    // 绑定回调函数，避免this指向问题\n    this._intersectionCallback = this._intersectionCallback.bind(this);\n    this._resizeCallback = this._resizeCallback.bind(this);\n  }\n\n  // 定义观察的属性\n  static get observedAttributes(): string[] {\n    return ['on-end-reached-threshold', 'has-next-page', 'on-start-reached-threshold', 'has-previous-page'];\n  }\n\n  // 属性变化时的回调\n  attributeChangedCallback(name: string, oldValue: string, newValue: string): void {\n    if (oldValue === newValue) return;\n    \n    switch (name) {\n      case 'on-end-reached-threshold':\n        this._updateThreshold('end', newValue);\n        break;\n      case 'on-start-reached-threshold':\n        this._updateThreshold('start', newValue);\n        break;\n      case 'has-next-page':\n        this._updateFlag('nextPage', newValue);\n        this._updateSlotVisibility(SlotType.Loading, SlotType.NoData, this._flags.get('nextPage') || false);\n        break;\n      case 'has-previous-page':\n        this._updateFlag('previousPage', newValue);\n        this._updateSlotVisibility(SlotType.TopLoading, null, this._flags.get('previousPage') || false);\n        break;\n    }\n  }\n\n  // 更新阈值\n  private _updateThreshold(type: string, value: string): void {\n    const threshold = Number(value) || 0;\n    this._thresholds.set(type, threshold);\n    \n    const refElement = type === 'end' \n      ? this._refElements.get(ObserverType.Bottom)\n      : this._refElements.get(ObserverType.Top);\n      \n    if (refElement) {\n      refElement.style.height = `${threshold}px`;\n    }\n  }\n\n  // 更新标志\n  private _updateFlag(type: string, value: string): void {\n    this._flags.set(type, value !== null && value !== 'false');\n  }\n\n  // 组件连接到 DOM 时\n  connectedCallback(): void {\n    // 初始化属性默认值\n    this._thresholds.set('end', Number(this.getAttribute('on-end-reached-threshold')) || 0);\n    this._thresholds.set('start', Number(this.getAttribute('on-start-reached-threshold')) || 0);\n    this._flags.set('nextPage', this.getAttribute('has-next-page') !== 'false');\n    this._flags.set('previousPage', this.getAttribute('has-previous-page') !== 'false');\n    \n    // 渲染组件\n    this._render();\n    \n    const scrollContainer = this._findScrollContainer();\n    \n    // 初始化观察器\n    this._initObserver(ObserverType.Bottom, scrollContainer);\n    this._initObserver(ObserverType.Top, scrollContainer);\n\n    // 初始化 ResizeObserver 监听父元素大小变化\n    this._resizeObserverRef = new ResizeObserver(this._resizeCallback);\n    if (this.parentElement) {\n      this._resizeObserverRef.observe(this.parentElement);\n    }\n  }\n\n  // 初始化观察器\n  private _initObserver(type: ObserverType, root: Element | null): void {\n    const observer = new IntersectionObserver(\n      (entries) => this._intersectionCallback(entries, type),\n      { threshold: 0.0, root }\n    );\n    \n    const refElement = this._refElements.get(type);\n    if (refElement) {\n      observer.observe(refElement);\n    }\n    \n    this._observers.set(type, observer);\n  }\n\n  // 组件从 DOM 断开连接时\n  disconnectedCallback(): void {\n    // 清理 IntersectionObserver\n    this._observers.forEach(observer => {\n      if (observer) {\n        observer.disconnect();\n      }\n    });\n    this._observers.clear();\n\n    // 清理 ResizeObserver\n    if (this._resizeObserverRef) {\n      this._resizeObserverRef.disconnect();\n      this._resizeObserverRef = null;\n    }\n  }\n\n  // 查找滚动容器\n  private _findScrollContainer(): Element | null {\n    let parent = this.parentElement;\n    \n    while (parent) {\n      const overflowY = window.getComputedStyle(parent).overflowY;\n      if (overflowY === 'auto' || overflowY === 'scroll') {\n        return parent;\n      }\n      parent = parent.parentElement;\n    }\n    \n    return null; // 如果没有找到滚动容器，则返回null，使用默认的viewport\n  }\n\n  // IntersectionObserver 统一回调\n  private _intersectionCallback(entries: IntersectionObserverEntry[], type: ObserverType): void {\n    const [target] = entries;\n    if (!(target.isIntersecting)) return;\n    \n    const eventConfig = {\n      [ObserverType.Bottom]: {\n        flag: 'nextPage',\n        event: 'end-reached'\n      },\n      [ObserverType.Top]: {\n        flag: 'previousPage',\n        event: 'start-reached'\n      }\n    };\n    \n    const config = eventConfig[type];\n    \n    // 只在标志为true时触发事件\n    if (this._flags.get(config.flag)) {\n      // 触发自定义事件\n      this.dispatchEvent(new CustomEvent(config.event, {\n        bubbles: true,\n        composed: true\n      }));\n    }\n  }\n\n  // ResizeObserver 回调\n  private _resizeCallback(): void {\n    // 当父元素大小变化时，重新初始化观察器\n    const scrollContainer = this._findScrollContainer();\n    \n    // 重新初始化所有观察器\n    this._observers.forEach((observer, type) => {\n      if (observer) {\n        observer.disconnect();\n        this._initObserver(type, scrollContainer);\n      }\n    });\n  }\n\n  // 更新插槽可见性\n  private _updateSlotVisibility(showSlot: SlotType, hideSlot: SlotType | null, condition: boolean): void {\n    const showSlotElement = this.shadowRoot?.querySelector(`.${showSlot}-slot`);\n    \n    if (showSlotElement) {\n      showSlotElement.className = condition ? `${showSlot}-slot contents` : `${showSlot}-slot hidden`;\n    }\n    \n    if (hideSlot) {\n      const hideSlotElement = this.shadowRoot?.querySelector(`.${hideSlot}-slot`);\n      if (hideSlotElement) {\n        hideSlotElement.className = condition ? `${hideSlot}-slot hidden` : `${hideSlot}-slot contents`;\n      }\n    }\n  }\n\n  // 创建带有具名插槽的容器\n  private _createSlotContainer(slotName: string, isVisible: boolean): HTMLDivElement {\n    const container = document.createElement('div');\n    container.className = isVisible ? `${slotName}-slot contents` : `${slotName}-slot hidden`;\n    \n    const slot = document.createElement('slot');\n    slot.setAttribute('name', slotName);\n    \n    container.appendChild(slot);\n    return container;\n  }\n\n  // 渲染组件\n  private _render(): void {\n    if (!this.shadowRoot) return;\n    \n    // 添加样式\n    const styleElement = document.createElement('style');\n    styleElement.textContent = style;\n    this.shadowRoot.appendChild(styleElement);\n    \n    // 创建容器\n    this._container = document.createElement('div');\n    this._container.setAttribute('part', 'container');\n    this._container.className = 'relative';\n    \n    // 创建顶部观察元素\n    const topRef = document.createElement('div');\n    topRef.className = 'absolute top-0 z-[-1]';\n    topRef.style.height = `${this._thresholds.get('start')}px`;\n    this._refElements.set(ObserverType.Top, topRef);\n    \n    // 创建底部观察元素\n    const bottomRef = document.createElement('div');\n    bottomRef.className = 'absolute bottom-0 z-[-1]';\n    bottomRef.style.height = `${this._thresholds.get('end')}px`;\n    this._refElements.set(ObserverType.Bottom, bottomRef);\n    \n    // 创建顶部加载中插槽\n    const hasPreviousPage = this._flags.get('previousPage') || false;\n    const topLoadingSlot = this._createSlotContainer(SlotType.TopLoading, hasPreviousPage);\n    \n    // 创建内容插槽\n    const defaultSlot = document.createElement('slot');\n    \n    // 创建底部加载中和无数据插槽\n    const hasNextPage = this._flags.get('nextPage') || false;\n    const loadingSlot = this._createSlotContainer(SlotType.Loading, hasNextPage);\n    const noDataSlot = this._createSlotContainer(SlotType.NoData, !hasNextPage);\n    \n    // 组装组件\n    this._container.appendChild(topRef);\n    this._container.appendChild(topLoadingSlot);\n    this._container.appendChild(defaultSlot);\n    this._container.appendChild(bottomRef);\n    this._container.appendChild(loadingSlot);\n    this._container.appendChild(noDataSlot);\n    \n    this.shadowRoot.appendChild(this._container);\n  }\n}\n\n// 注册自定义元素\ncustomElements.define('infinite-scroll-list', InfiniteScrollList);\n"],"names":["ObserverType","SlotType","InfiniteScrollList","HTMLElement","constructor","super","this","_observers","Map","_resizeObserverRef","_refElements","_thresholds","_flags","_container","attachShadow","mode","set","Top","Bottom","_intersectionCallback","bind","_resizeCallback","observedAttributes","attributeChangedCallback","name","oldValue","newValue","_updateThreshold","_updateFlag","_updateSlotVisibility","Loading","NoData","get","TopLoading","type","value","threshold","Number","refElement","style","height","connectedCallback","getAttribute","_render","scrollContainer","_findScrollContainer","_initObserver","ResizeObserver","parentElement","observe","root","observer","IntersectionObserver","entries","disconnectedCallback","forEach","disconnect","clear","parent","overflowY","window","getComputedStyle","target","config","flag","event","dispatchEvent","CustomEvent","bubbles","composed","showSlot","hideSlot","condition","showSlotElement","shadowRoot","querySelector","className","hideSlotElement","_createSlotContainer","slotName","isVisible","container","document","createElement","slot","setAttribute","appendChild","styleElement","textContent","topRef","bottomRef","hasPreviousPage","topLoadingSlot","defaultSlot","hasNextPage","loadingSlot","noDataSlot","customElements","define"],"mappings":"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"}